# DB Secret Operator

A Kubernetes operator that automatically generates database credentials and connection URIs using a custom AutoSecret CRD.

## Features

- **Custom Resource**: Uses `AutoSecret` CRD for declarative secret management
- **Automatic Password Generation**: Creates cryptographically secure passwords
- **Dual Secret Creation**: Automatically creates both basic-auth and connection URI secrets
- **Owner References**: Secrets are automatically cleaned up when AutoSecret is deleted
- **URL Encoding**: Properly encodes special characters in passwords for URIs

## How It Works

Create an `AutoSecret` resource with database connection details. The operator automatically creates:

1. **Basic-auth secret** (`<name>-basic-auth`) - Contains username and auto-generated password
2. **DB URI secret** (`<name>-db-uri`) - Contains connection strings and individual connection parameters

## Installation

### Prerequisites

- Kubernetes cluster (v1.24+)
- kubectl configured
- Docker (for building images)

### Deploy to Minikube

```powershell
# Clone and navigate to repository
cd db-secret-operator

# Deploy operator (builds image, applies CRD, RBAC, deployment)
.\deploy-minikube.ps1
```

### Manual Deployment

```bash
# Apply CRD
kubectl apply -f deploy/crds/auto-secret.io_autosecrets.yaml

# Apply namespace and RBAC
kubectl apply -f deploy/namespace.yaml
kubectl apply -f deploy/rbac.yaml

# Build and deploy operator
docker build -t db-secret-operator:latest .
kubectl apply -f deploy/deployment.yaml
```

### Verify Installation

```bash
# Check operator is running
kubectl get pods -n db-secret-operator-system

# Verify CRD is installed
kubectl get crds | grep autosecret
```

## Usage

### Basic Example

```yaml
apiVersion: auto-secret.io/v1alpha1
kind: AutoSecret
metadata:
  name: myapp-db-readonly
  namespace: mynamespace
spec:
  username: myapp-db-user
  dbname: myapp_db
  dbhost: postgres-cluster
  # port: 5432  # optional, defaults to 5432
```

Apply the AutoSecret:

```bash
# Create namespace
kubectl apply -f examples/mynamespace.yaml

# Create AutoSecret
kubectl apply -f examples/autosecret-example.yaml
```

This automatically creates two secrets:

1. `myapp-db-readonly-basic-auth` (type: BasicAuth)
   - `username`: myapp-db-user
   - `password`: <auto-generated>

2. `myapp-db-readonly-db-uri` (type: Opaque)
   - `DATABASE_URI`: postgresql://myapp-db-user:password@postgres-cluster:5432/myapp_db
   - `DB_HOST`: postgres-cluster
   - `DB_NAME`: myapp_db
   - `DB_PORT`: 5432
   - `DB_USER`: myapp-db-user
   - `DB_PASSWORD`: <same as basic-auth>

### Using Secrets in Deployments

```yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: myapp
spec:
  template:
    spec:
      containers:
      - name: app
        image: myapp:latest
        env:
        # Use the full connection URI
        - name: DATABASE_URI
          valueFrom:
            secretKeyRef:
              name: myapp-db-readonly-db-uri
              key: DATABASE_URI

        # Or use individual credentials
        - name: DB_USER
          valueFrom:
            secretKeyRef:
              name: myapp-db-readonly-basic-auth
              key: username
        - name: DB_PASSWORD
          valueFrom:
            secretKeyRef:
              name: myapp-db-readonly-basic-auth
              key: password
```

### Check AutoSecret Status

```bash
# View AutoSecret and its status
kubectl get autosecret -n mynamespace
kubectl describe autosecret myapp-db-readonly -n mynamespace

# View created secrets
kubectl get secrets -n mynamespace | grep myapp-db-readonly
```

## Development

### Project Structure

```
db-secret-operator/
├── api/v1alpha1/
│   ├── autosecret_types.go      # CRD definition
│   └── groupversion_info.go     # API group info
├── controllers/
│   └── autosecret_controller.go # Reconciliation logic
├── deploy/
│   ├── crds/                    # Generated CRD manifests
│   ├── namespace.yaml
│   ├── rbac.yaml
│   └── deployment.yaml
├── examples/
│   ├── autosecret-example.yaml
│   └── mynamespace.yaml
├── main.go
├── Dockerfile
└── deploy-minikube.ps1
```

### Build and Test Locally

```bash
# Build binary
go build -o manager.exe main.go

# Run tests
go test ./...

# Generate CRD manifests after API changes
controller-gen object:headerFile=hack/boilerplate.go.txt paths="./api/v1alpha1/..."
controller-gen crd:crdVersions=v1 paths="./api/v1alpha1/..." output:crd:dir=./deploy/crds
```

### Updating the CRD

After modifying `api/v1alpha1/autosecret_types.go`:

1. Regenerate manifests:
   ```bash
   go install sigs.k8s.io/controller-tools/cmd/controller-gen@latest
   controller-gen object:headerFile=hack/boilerplate.go.txt paths="./api/v1alpha1/..."
   controller-gen crd:crdVersions=v1 paths="./api/v1alpha1/..." output:crd:dir=./deploy/crds
   ```

2. Rebuild and redeploy:
   ```powershell
   .\deploy-minikube.ps1
   ```

## Architecture

- **AutoSecret CRD**: Defines the desired database connection configuration
- **Controller**: Watches AutoSecret resources and reconciles secrets
- **Owner References**: Child secrets are owned by AutoSecret (automatic cleanup)
- **Status Tracking**: Tracks created secret names in AutoSecret status

### Security Features

- **Cryptographically secure passwords**: Uses `crypto/rand`
- **URL encoding**: Escapes special characters in connection URIs
- **Non-root containers**: Runs as user 65532 with dropped capabilities
- **Read-only filesystem**: Uses distroless base image
- **RBAC**: Minimal required permissions

## Troubleshooting

### Operator not starting

Check RBAC permissions:
```bash
kubectl logs -n db-secret-operator-system -l app=db-secret-operator
```

Common issues:
- CRD not installed: `kubectl apply -f deploy/crds/auto-secret.io_autosecrets.yaml`
- RBAC missing: `kubectl apply -f deploy/rbac.yaml`

### Secrets not being created

1. Check AutoSecret status:
   ```bash
   kubectl describe autosecret <name> -n <namespace>
   ```

2. View operator logs:
   ```bash
   kubectl logs -n db-secret-operator-system -l app=db-secret-operator -f
   ```

3. Verify namespace exists:
   ```bash
   kubectl get namespace <namespace>
   ```

### Update not applying

Delete the AutoSecret and recreate it:
```bash
kubectl delete autosecret <name> -n <namespace>
kubectl apply -f your-autosecret.yaml
```

Note: Deleting AutoSecret also deletes the generated secrets (owner references).

## API Reference

### AutoSecret Spec

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `username` | string | Yes | Database username |
| `dbname` | string | Yes | Database name |
| `dbhost` | string | Yes | Database host/service name |
| `port` | int | No | Database port (default: 5432) |

### AutoSecret Status

| Field | Type | Description |
|-------|------|-------------|
| `basicAuthSecretName` | string | Name of created basic-auth secret |
| `dbURISecretName` | string | Name of created DB URI secret |
| `conditions` | []Condition | Status conditions |

## Limitations

- Only supports PostgreSQL
- Password is generated once and not rotated automatically
- Does not create actual database users (credentials only)

## Roadmap

- [ ] Add password rotation support
- [ ] Support for additional database types
- [ ] Add TLS/SSL connection parameters
- [ ] Webhook for validation
- [ ] Integration with external secret managers

## Contributing

Contributions welcome! Please submit a Pull Request.

## License

MIT License

## Acknowledgments

Built with [controller-runtime](https://github.com/kubernetes-sigs/controller-runtime)
